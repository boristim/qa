<?php
/**
 * Created by PhpStorm.
 * User: salem
 * Date: 03.04.2019
 * Time: 22:40
 */
define('DEFAULT_ANSWER_TITLE', 'some answer title');
/**
 * Implements hook_views_pre_render().
 */
function qa_views_pre_render(&$view) {
  if ($view->name == 'question' && $view->current_display == 'page') {
    $view->build_info['title'] = $view->build_info['substitutions']['%1'];
  }
}

/**
 * Implements hook_form_alter().
 */
function qa_form_alter(&$form, &$form_state, $form_id) {
//  dsm($form_id);
}


/**
 * Implements hook_form_FORM_ID_alter().
 */
function qa_form_answer_node_form_alter(&$form, &$form_state, $extra) {
  if (!isset($form['nid']['#value'])) {
    $form['field_question_ref']['#access'] = false;
    $form['field_question_ref']['und']['#options'] = [];
    if (($question = node_load(arg(1))) && ($question->type = 'question')) {
      $form['field_question_ref']['und']['#options'] = [$question->nid => $question->title];
      $form['field_question_ref']['und']['#default_value'] = [$question->nid];
    }
    $form['title']['#access'] = false;
    $form['title']['#default_value'] = DEFAULT_ANSWER_TITLE;
    $form['field_rate']['#access'] = user_access('edit any answer content');
    $form['#submit'][] = '_qa_form_answer_node_form_submit';
    $form['#validate'][] = '_qa_form_answer_node_form_validate';
    $css = <<<CSS
.node-form.node-answer-form .filter-wrapper.form-wrapper,
.node-form.node-answer-form #edit-field-question-ref,
.node-form.node-answer-form .vertical-tabs.clearfix {
  display: none;
}
CSS;
    $form['#attached']['css'][] = ['data' => $css, 'type' => 'inline'];
    dpm($form);
  }
}

function _qa_form_answer_node_form_validate($form, &$form_state) {
  global $user;

}

function _qa_form_answer_node_form_submit($form, &$form_state) {
  if (!user_access('edit any answer content')) {
    drupal_set_message('После модерации ваш ответ будет опубликован');
  }
  $_GET['destination'] = '/question/' . $form_state['values']['field_question_ref']['und'][0]['target_id'];
}

/**
 * Implements hook_node_submit().
 */
function qa_node_submit($node, $form, &$form_state) {
  switch ($node->type) {
    case 'answer':
      $node->title = mb_substr($node->body['und'][0]['value'], 0, 255);
      $node->status = user_access('edit any answer content') ? 1 : 0;
      break;
    default:
  }
}
